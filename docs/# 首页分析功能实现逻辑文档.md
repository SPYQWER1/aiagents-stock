# 首页分析功能实现逻辑文档

本文档详细介绍了 `aiagents-stock` 系统首页（`home.py`）中“单股分析”与“批量分析”功能的实现逻辑。该模块作为系统的表现层（Presentation Layer），主要负责用户交互、任务调度以及结果展示，核心业务逻辑委托给应用层（Application Layer）的 Use Cases 处理。

## 1. 核心架构概述

首页采用 **Streamlit** 框架构建，遵循 DDD（领域驱动设计）架构规范：
*   **表现层 (`home.py`)**: 负责 UI 渲染、输入校验、状态管理和调用应用层服务。
*   **应用服务层 (`analysis_service.py`)**: 封装 Use Case 的调用，处理数据预加载和依赖注入。

主要入口函数为 `render_home`，它根据用户选择的模式（单个分析/批量分析）分发到不同的处理流程。

---

## 2. 单股分析实现逻辑

单股分析旨在为用户提供深度的个股多 Agent 协同分析报告。

### 2.1 交互流程
1.  **输入与校验**: 用户输入股票代码（如 `AAPL`, `00700`），系统通过 `_validate_before_run` 校验 API Key、股票代码有效性及分析师配置。
2.  **数据预加载 (UI 优化)**:
    *   在启动耗时的 AI 分析前，优先调用 `get_stock_data` 和 `get_financial_data` 获取基础行情和财务数据。
    *   **目的**: 立即渲染 K 线图和基本信息，减少用户等待焦虑，提升体验。
3.  **任务执行**:
    *   调用 `_run_single_analysis_use_case_ui` 函数。
    *   通过 `analyze_single_stock_via_use_case` 将预加载的数据传入应用层，避免重复请求。
4.  **结果渲染**:
    *   按顺序展示：各分析师观点 (`display_agents_analysis`) -> 团队讨论 (`display_team_discussion`) -> 最终决策 (`display_final_decision`)。
5.  **状态持久化**:
    *   分析结果存入 `st.session_state`，防止页面交互（如点击折叠按钮）导致数据丢失。

### 2.2 关键代码路径
*   **入口**: `_run_single_analysis_use_case_ui`
*   **服务调用**: `aiagents_stock.web.services.analysis_service.analyze_single_stock_via_use_case`

---

## 3. 批量分析实现逻辑

批量分析支持对一组股票进行快速扫描，分为“顺序分析”和“多线程并行”两种模式。

### 3.1 交互流程
1.  **输入解析**:
    *   支持多行输入或逗号分隔格式，通过 `parse_stock_list` 解析为股票列表。
    *   包含数量限制警告（建议不超过推荐阈值）。
2.  **模式选择**:
    *   **顺序分析**: 稳定性高，按列表顺序逐个执行。
    *   **多线程并行**: 速度快，利用线程池并发执行（需权衡 API 速率限制）。
3.  **任务执行 (`_run_batch_analysis_ui`)**:
    *   **生成器模式**: 调用 `analyze_batch_stocks_via_use_case`，该函数返回一个生成器（Generator）。
    *   **实时反馈**: 使用 `for` 循环迭代生成器，每完成一只股票的分析，立即更新进度条 (`st.progress`) 和状态文本。
    *   **容错处理**: 捕获单只股票的异常，确保某只股票失败不会中断整个批量任务。
4.  **结果聚合**:
    *   收集所有成功和失败的结果，统计成功率。
    *   结果对象包含：股票基础信息、分析结果摘要、数据库记录 ID 等。
5.  **页面跳转**:
    *   分析完成后，将结果集存入 `st.session_state.batch_analysis_results`。
    *   调用 `st.rerun()` 触发页面重载，逻辑跳转至批量结果展示页 (`display_batch_analysis_results`)。

### 3.2 关键代码路径
*   **入口**: `_run_batch_analysis_ui`
*   **服务调用**: `aiagents_stock.web.services.analysis_service.analyze_batch_stocks_via_use_case`
*   **并发控制**: 依赖应用层的 `BatchAnalyzeStocksUseCase` 处理并发/顺序逻辑。

---

## 4. 状态管理与缓存

*   **Session State**:
    *   `analysis_completed`: 标记单股分析是否完成，控制结果回显。
    *   `batch_analysis_results`: 存储批量分析结果，用于页面间数据传递。
    *   `agents_results`, `final_decision`: 缓存单股分析的详细数据。
*   **Data Cache**:
    *   利用 `st.cache_data` 缓存基础行情和财务数据，避免频繁请求外部 API。
    *   提供“清除缓存”按钮，手动调用 `st.cache_data.clear()`。